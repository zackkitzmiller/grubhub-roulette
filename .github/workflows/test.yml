name: ğŸ§ª Test Grubhub Roulette Extension

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch: # Allow manual triggering

jobs:
  test:
    name: ğŸ¯ Run Extension Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          # Install jq for JSON validation
          sudo apt-get update
          sudo apt-get install -y jq

          # Create package.json if it doesn't exist
          if [ ! -f package.json ]; then
            echo '{"name": "grubhub-roulette", "version": "2.0.0", "scripts": {"test": "./test.sh"}}' > package.json
          fi

      - name: ğŸ” Validate file structure
        run: |
          echo "ğŸ“ Checking required files..."
          required_files=("manifest.json" "popup.html" "css/popup.css" "js/popup.js" "js/content.js" "js/background.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          echo "âœ… All required files present"

      - name: ğŸ“‹ Validate JSON files
        run: |
          echo "ğŸ“‹ Validating JSON syntax..."
          if ! jq empty manifest.json; then
            echo "âŒ manifest.json has invalid JSON syntax"
            exit 1
          fi
          echo "âœ… JSON files are valid"

      - name: âš™ï¸ Check JavaScript syntax
        run: |
          echo "âš™ï¸ Checking JavaScript syntax..."
          js_files=("js/popup.js" "js/content.js" "js/background.js")
          for js_file in "${js_files[@]}"; do
            if ! node -c "$js_file"; then
              echo "âŒ Syntax error in $js_file"
              exit 1
            fi
          done
          echo "âœ… JavaScript syntax is valid"

      - name: ğŸ”§ Make test scripts executable
        run: |
          chmod +x tests/test.sh tests/quick-test.sh

      - name: ğŸš€ Run quick tests
        run: |
          echo "ğŸš€ Running quick test suite..."
          ./tests/quick-test.sh

      - name: ğŸ§ª Run comprehensive tests
        run: |
          echo "ğŸ§ª Running comprehensive test suite..."
          ./tests/test.sh

      - name: ğŸ“Š Test extension manifest
        run: |
          echo "ğŸ“Š Validating extension manifest..."

          # Check manifest version
          if ! grep -q '"manifest_version": 3' manifest.json; then
            echo "âŒ Extension must use Manifest V3"
            exit 1
          fi

          # Check required permissions
          if ! grep -q '"permissions"' manifest.json; then
            echo "âŒ Extension must declare permissions"
            exit 1
          fi

          # Check content scripts
          if ! grep -q '"content_scripts"' manifest.json; then
            echo "âŒ Extension must have content scripts"
            exit 1
          fi

          # Check for search URL support
          if ! grep -q "grubhub.com/search" manifest.json; then
            echo "âŒ Extension must support search URLs"
            exit 1
          fi

          echo "âœ… Extension manifest is valid"

      - name: ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Check family-friendly content
        run: |
          echo "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Checking for family-friendly content..."

          inappropriate_words=("bitch" "damn" "shit" "hell")
          files_to_check=("popup.html" "js/popup.js" "js/content.js" "js/background.js" "README.md")

          found_inappropriate=false
          for word in "${inappropriate_words[@]}"; do
            for file in "${files_to_check[@]}"; do
              if [ -f "$file" ] && grep -qi "$word" "$file"; then
                echo "âŒ Found inappropriate word '$word' in $file"
                found_inappropriate=true
              fi
            done
          done

          if [ "$found_inappropriate" = true ]; then
            exit 1
          fi

          echo "âœ… Content is family-friendly"

      - name: ğŸ¨ Validate CSS and HTML
        run: |
          echo "ğŸ¨ Validating CSS and HTML structure..."

          # Check for required HTML elements
          if ! grep -q 'id="spinWheelButton"' popup.html; then
            echo "âŒ Missing spin button in popup.html"
            exit 1
          fi

          if ! grep -q 'id="optionsToggle"' popup.html; then
            echo "âŒ Missing options toggle in popup.html"
            exit 1
          fi

          # Check for required CSS classes
          css_classes=("spin-button" "options" "status-message" "option-label")
          for class in "${css_classes[@]}"; do
            if ! grep -q "\.$class" css/popup.css; then
              echo "âŒ Missing CSS class: .$class"
              exit 1
            fi
          done

          echo "âœ… CSS and HTML structure is valid"

      - name: ğŸ“ˆ Generate test report
        if: always()
        run: |
          echo "ğŸ“ˆ Test Summary"
          echo "=============="
          echo "âœ… Extension structure validated"
          echo "âœ… JavaScript syntax checked"
          echo "âœ… JSON files validated"
          echo "âœ… Manifest requirements verified"
          echo "âœ… Family-friendly content confirmed"
          echo "âœ… CSS/HTML structure validated"
          echo ""
          echo "ğŸ‰ All automated tests completed!"
          echo ""
          echo "ğŸ“‹ Next steps for manual testing:"
          echo "1. Load extension in Chrome (chrome://extensions/)"
          echo "2. Test on: https://grubhub.com/search?queryText=pizza"
          echo "3. Verify random restaurant selection works"

      - name: ğŸ“¤ Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-logs
          path: |
            *.log
            test-results.txt
          retention-days: 7
