name: ğŸš€ Release to Chrome Web Store

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-publish:
    name: ğŸ“¦ Build & Publish Extension
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“¦ Install dependencies
        run: |
          # Install jq for JSON validation and zip for packaging
          sudo apt-get update
          sudo apt-get install -y jq zip

      - name: ğŸ” Validate extension
        run: |
          echo "ğŸ” Validating extension files..."

          # Check required files
          required_files=("manifest.json" "popup.html" "css/popup.css" "js/popup.js" "js/content.js" "js/background.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done

          # Validate JSON
          if ! jq empty manifest.json; then
            echo "âŒ manifest.json has invalid JSON syntax"
            exit 1
          fi

          # Check JavaScript syntax
          js_files=("js/popup.js" "js/content.js" "js/background.js")
          for js_file in "${js_files[@]}"; do
            if ! node -c "$js_file"; then
              echo "âŒ Syntax error in $js_file"
              exit 1
            fi
          done

          echo "âœ… Extension validation passed"

      - name: ğŸ“‹ Update version from release
        run: |
          echo "ğŸ“‹ Updating version from release tag..."

          # Get version from release tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF_NAME#v}
          echo "Version: $VERSION"

          # Update manifest.json version
          jq --arg version "$VERSION" '.version = $version' manifest.json > manifest.json.tmp
          mv manifest.json.tmp manifest.json

          # Update package.json version
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "âœ… Updated version to $VERSION"

      - name: ğŸ—ï¸ Build extension package
        run: |
          echo "ğŸ—ï¸ Building extension package..."

          # Create build directory
          mkdir -p build

          # Copy all necessary files to build directory
          cp manifest.json build/
          cp popup.html build/
          cp -r css/ build/
          cp -r js/ build/
          cp -r icons/ build/

          # Create zip file for Chrome Web Store
          cd build
          zip -r ../grubhub-roulette-v${VERSION}.zip . -x "*.DS_Store" "*.git*" "*.md" "tests/*" "docs/*" ".github/*"
          cd ..

          echo "âœ… Extension package created: grubhub-roulette-v${VERSION}.zip"

          # List contents for verification
          echo "ğŸ“¦ Package contents:"
          unzip -l grubhub-roulette-v${VERSION}.zip

      - name: ğŸ“¤ Upload to Chrome Web Store
        uses: google-chrome-web-store-upload@v1
        with:
          extensionId: ${{ secrets.CHROME_EXTENSION_ID }}
          clientId: ${{ secrets.CHROME_CLIENT_ID }}
          clientSecret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refreshToken: ${{ secrets.CHROME_REFRESH_TOKEN }}
          zipFile: grubhub-roulette-v${VERSION}.zip
          publish: true

      - name: ğŸ“Š Create release summary
        run: |
          echo "ğŸ“Š Release Summary"
          echo "=================="
          echo "âœ… Extension built successfully"
          echo "âœ… Version: $VERSION"
          echo "âœ… Package: grubhub-roulette-v${VERSION}.zip"
          echo "âœ… Published to Chrome Web Store"
          echo ""
          echo "ğŸ‰ Release completed successfully!"

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grubhub-roulette-v${VERSION}
          path: |
            grubhub-roulette-v${VERSION}.zip
            build/
          retention-days: 30

      - name: ğŸ·ï¸ Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./grubhub-roulette-v${VERSION}.zip
          asset_name: grubhub-roulette-v${VERSION}.zip
          asset_content_type: application/zip
